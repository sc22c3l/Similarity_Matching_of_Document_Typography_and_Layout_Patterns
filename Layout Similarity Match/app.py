group=[

       [
[1,1,0,0,0,0,0,0,0,0],
[0,1,1,0,0,0,0,0,0,0],
[0,0,1,1,0,0,0,0,0,0],
[0,0,0,1,1,0,0,0,0,0],
[0,0,0,0,1,1,0,0,0,0],
[0,0,0,0,0,1,1,0,0,0],
[0,0,0,0,0,0,1,1,0,0],
[0,0,0,0,0,0,0,1,1,0],
[0,0,0,0,0,0,0,0,1,1],
[0,0,0,0,0,0,0,0,1,1],
[0,0,0,0,0,0,0,1,1,0],
[0,0,0,0,0,0,1,1,0,0],
[0,0,0,0,0,1,1,0,0,0],
[0,0,0,0,1,1,0,0,0,0],
[0,0,0,1,1,0,0,0,0,0],
[0,0,1,1,0,0,0,0,0,0]
         ],
# Aligned
         [
 [1,1,1,1,1,1,1,0,0,0],
 [1,1,1,1,1,1,0,0,0,0],
 [1,1,1,1,0,0,0,0,0,0],
 [1,1,1,1,1,0,0,0,0,0],
 [1,1,1,1,1,1,0,0,0,0],
 [1,1,1,1,1,0,0,0,0,0],
 [1,1,1,1,1,1,1,0,0,0],
 [1,1,1,1,1,0,0,0,0,0],
 [1,1,1,1,1,1,1,1,0,0],
 [1,1,1,1,1,1,0,0,0,0],
 [1,1,1,1,1,1,0,0,0,0],
 [1,1,1,1,1,0,0,0,0,0],
 [1,1,1,1,1,1,1,0,0,0],
 [1,1,1,1,1,0,0,0,0,0],
 [1,1,1,1,1,1,1,0,0,0],
 [1,1,1,1,1,0,0,0,0,0]
         ],
# Centered
         [
[0,0,0,0,1,1,0,0,0,0],
[0,1,1,1,1,1,1,1,1,0],
[0,0,1,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,0,0,0],
[0,0,0,1,1,1,1,0,0,0],

[0,0,0,1,1,1,1,0,0,0],
[0,1,1,1,1,1,1,1,1,0],
[0,0,1,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,0,0,0],
[0,0,0,1,1,1,1,0,0,0],

[0,0,0,1,1,1,1,0,0,0],
[0,1,1,1,1,1,1,1,1,0],
[0,0,1,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,0,0,0],
[0,0,0,1,1,1,1,0,0,0],
[0,0,0,0,1,1,0,0,0,0]
         ],
# Meshed alternately 4
         [
[1,1,1,1,0,0,0,0,0,0],
[0,0,1,1,1,1,1,0,0,0],
[1,1,1,1,1,0,0,0,0,0],
[0,0,1,1,1,1,1,0,0,0],
[0,1,1,1,1,0,0,0,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,1,1,1,0,0,0,0,0],
[0,0,0,0,1,1,1,1,1,0],
[1,1,1,1,1,0,0,0,0,0],
[0,0,1,1,1,1,1,0,0,0],
[1,1,1,1,1,0,0,0,0,0],
[0,0,1,1,1,1,1,0,0,0],
[1,1,1,1,1,0,0,0,0,0],
[0,0,1,1,1,1,1,0,0,0],
[1,1,1,1,1,0,0,0,0,0],
[0,0,1,1,1,1,1,0,0,0]
         ],  
        #  Matching end-start5
         [
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1],
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1],
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1],
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1],
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1],
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1],
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1],
[1,1,1,1,1,1,0,0,0,0],
[0,0,0,0,0,0,1,1,1,1]
         ],
        #  Casced 6
         [
[1,1,1,0,0,0,0,0,0,0],
[0,1,1,1,1,0,0,0,0,0],
[0,0,0,1,1,1,0,0,0,0],
[0,0,0,0,1,1,1,1,0,0],
[0,0,0,0,0,0,1,1,1,1]
         ],
         
    #  Framing 7
         [
[1,1,1,1,1,1,1,1,1,1],
[1,1,1,1,1,1,1,1,1,1],
[1,1,1,0,0,0,0,0,1,1],
[1,0,0,0,0,0,0,0,1,1],
[1,0,0,0,0,0,0,0,1,1],
[1,1,1,1,1,1,1,1,1,1],
[1,1,1,1,1,1,1,1,1,1]

         ],
    
        # Central cross: 
[[0,0,0,0,0,1,0,0,0,0],
 [0,0,0,0,0,1,0,0,0,0],
 [0,0,0,0,0,1,0,0,0,0],
 [0,0,0,0,0,1,0,0,0,0],
 [1,1,1,1,1,1,1,1,1,1],
 [0,0,0,0,0,1,0,0,0,0],
 [0,0,0,0,0,1,0,0,0,0],
 [0,0,0,0,0,1,0,0,0,0],
 [0,0,0,0,0,1,0,0,0,0],
 [0,0,0,0,0,1,0,0,0,0]] ,


# Centered square:
[
 [0,0,0,1,1,1,1,0,0,0],
 [0,0,0,1,1,1,1,0,0,0],
 [0,0,0,1,1,1,1,0,0,0],
 [0,0,0,1,1,1,1,0,0,0],
 [0,0,0,1,1,1,1,0,0,0],
 [0,0,0,1,1,1,1,0,0,0]],

# Hourglass shape:10
[[1,1,1,1,1,1,1,1,1,1],
 [0,1,1,1,1,1,1,1,1,0],
 [0,0,1,1,1,1,1,1,0,0],
 [0,0,0,1,1,1,1,0,0,0],
 [0,0,0,0,1,1,0,0,0,0],
 [0,0,0,0,1,1,0,0,0,0],
 [0,0,0,1,1,1,1,0,0,0],
 [0,0,1,1,1,1,1,1,0,0],
 [0,1,1,1,1,1,1,1,1,0],
 [1,1,1,1,1,1,1,1,1,1]],


[[1,1,1,1,1,1,1,1,1],
 [0,0,0,0,0,0,0,1,1],
 [1,1,1,1,1,1,1,1,1],
 [1,1,1,1,1,1,0,0,0],
 [1,1,1,1,1,1,1,1,1],
 [0,0,0,0,0,0,0,1,1],
 [1,1,1,1,1,1,1,1,1],
 [1,1,1,1,0,0,0,0,0],
 [1,1,1,1,1,1,1,1,1]]

# ,
# [[0,0,0,1,1,1,1,1,1,1,1,1,0,0,0],
#  [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
#  [0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],
#  [1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
#  [1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
#  [1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
#  [1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
#  [1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
#  [1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
#  [0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],
#  [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
#  [0,0,0,1,1,1,1,1,1,1,1,1,0,0,0]]111

         
      ]
from flask import Flask, render_template, request, redirect, url_for, flash
import os
import cv2_test1
import cv2
import ast

import subprocess

def run_prolog_query(query):
    prolog_process = subprocess.Popen(['swipl', '-q', '-f', 'pl 717.pl'],
                                      stdin=subprocess.PIPE,
                                      stdout=subprocess.PIPE,
                                      stderr=subprocess.PIPE,
                                      text=True)
    
    stdout, stderr = prolog_process.communicate(query)
    return stdout.strip()

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'uploads/'  # Directory where uploaded images will be stored
app.secret_key = "secret_key"  # Secret key for flash messaging

@app.route('/')
def index():
    result = request.args.get('result', '')  # Get result from the request arguments
    return render_template('index.html', result=result)

@app.route('/upload', methods=['POST'])
def upload():
    result = ''
    selected_mode = request.form.get('mode')
    top_n = request.form.get('topn')
    if 'image' in request.files and selected_mode == "image_mode":
        image = request.files['image']
        if image.filename != '':
            image_path = os.path.join(app.config['UPLOAD_FOLDER'], image.filename)
            image.save(image_path)
            print('<-----------------image_path----------------->',image_path)
            flash('Image uploaded successfully!', 'success')
            # image = cv2.imread(image_path,0)
            result=str(cv2_test1.line_mark(image_path))
            print('CCCCCCCCCCCC\n',result,'\n')
            # result_img=str(cv2_test1.line_mark(image_path))
    
    textinput = request.form.get('textinput')
    if textinput and selected_mode == "group_mode":
        # Process the text as needed
        flash(f'Received text: {textinput}', 'info')
        # queries = [
        #     "group1(X), groups_compare(X, "+ str(textinput)+", Y), groups_result(Y, X, Z),write(Y),  halt."
        # ]
        query0="linetype( "+ str(textinput)+", Y),write(Y),  halt."
        res0 = run_prolog_query(query0)
        result='The line pattern of input group is: '+res0+'.\n'
        query1="group1(X), groups_compare(X, "+ str(textinput)+", Y), groups_result(Y, X, Z),write(Y),  halt."
        res1 = run_prolog_query(query1)
        array = ast.literal_eval(res1)
        sorted_index = sorted(range(len(array)), key=lambda x: array[x], reverse=True)
        for i in range(int(top_n)):
            index=sorted_index[i]
            formatted_num = "{:.2f}".format(array[index])
            result=result+str('The top '+str(i+1)+' similar example in database is:\n'+ str(group[index]) + '\n and the similarity index is: ' + str(formatted_num)+
                              '\n\n<--------------------------------------------------->\n')

        # print('11111111111\n',array[0])
        # query2="group1(X), groups_compare(X, "+ str(textinput)+", Y), groups_result(Y, X, Z),write(Y),  halt."
        # res2 = run_prolog_query(query2)
        # result=str(res1)
        # print(1)
        # for query in queries:
        #     result = run_prolog_query(query)
        #     print('I:',result)

            
    return redirect(url_for('index', result=result))

if __name__ == '__main__':
    app.run(debug=True)
